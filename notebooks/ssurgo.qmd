---
jupyter: python3
author: Corey T. White
execute:
  eval: true
  freeze: auto
date-modified: today
format:
  html:
    toc: true
    code-tools: true
    code-copy: true
    code-fold: false
---

# SSURGO Soil Data in GRASS

```{python}
# | label: imports
# | echo: false
import os
import subprocess
import sys

# import numpy as np
import matplotlib.pyplot as plt
from pprint import pprint
from PIL import Image
import pandas as pd
import sqlite3
from IPython.display import IFrame
import numpy as np
import seaborn as sns
import pandas as pd

# Ask GRASS GIS where its Python packages are.
sys.path.append(
    subprocess.check_output(["grass", "--config", "python_path"], text=True).strip()
)

# Import the GRASS GIS packages we need.
import grass.script as gs

# Import GRASS Jupyter
import grass.jupyter as gj
from grass.tools import Tools
```

```{python}
# | label: init_session
gisdb = os.path.join(os.getenv("HOME"), "grassdata")
site = "coweeta"
mapset = "ssurgo_demo"
session = gj.init(gisdb, site, "PERMANENT")
tools = Tools(session=session)
try:
    tools.g_mapset(mapset=mapset, flags="c")
except Exception as e:
    print(f"{e}")
```

Install the `r.in.ssurgo` extension if it is not already installed. This extension is available in the GRASS Addons repository and can be installed using `g.extension`. The source code for this extension is also available in the `tools/r.soildb/r.in.ssurgo` directory of this repository.

```{python}
# | label: install_extension
# | eval: false
tools.g_extension(
    extension="r.in.ssurgo",
    url="../tools/r.soildb/r.in.ssurgo",
)
```

Set the computational region to the elevation raster and create a relief raster for hillshading.

```{python}
# | label: set_region
region_text = tools.g_region(raster="elevation", flags="p").text
tools.r_relief(input="elevation", output="relief")
print(region_text)
```

Import SSURGO data using `r.in.ssurgo`. Note that this will import the soil areas map, hydrologic group map, and ksat maps for low, regular, and high values. The `mukey` column is also imported as a raster with a categorical color scheme applied. The hydrologic group map also has a categorical color scheme applied.

```{python}
# | label: import_ssurgo
# | eval: false
tools.r_in_ssurgo(
    ssurgo_path="../data/gSSURGO_CONUS.zip/gSSURGO_CONUS.gdb",
    ssurgo_areas="soil_areas",
    hydgrp="hydgrp",
    ksat_l="ksat_l",
    ksat_r="ksat_r",
    ksat_h="ksat_h",
    mukey="mukey",
    hzdept_r=0,
    hzdepb_r=100,
    desgnmaster="A",
)
```

```{python}
# | label: vector_maps
print(tools.g_list(type="vector", mapset=mapset).text)
```

```{python}
# | label: soil attributes
json_data = tools.v_db_select(map="soil_areas", format="json").json
df = pd.DataFrame(json_data["records"])
df.head()
```

```{python}
# | label: list_rasters
print(tools.g_list(type="raster", mapset=mapset).text)
```

## MUKEY Map
```{python}
# | label: mukey
m = gj.Map(use_region=True)
m.d_shade(shade="relief", color="mukey")
# m.d_legend(raster="mukey", title="MUKEY", flags="b")
m.show()
```

## Ksat Maps

### Regular
```{python}
# | label: ksat
# | layout-ncol: 3
# | fig-cap: "Ksat maps for low, regular, and high values"
# | fig-subcap:
# |     - Low
# |     - Regular
# |     - High


m = gj.Map(use_region=True)
m.d_shade(shade="relief", color="ksat_l")
m.d_legend(raster="ksat_l", title="Ksat (mm/hr)", flags="b")
m.show()

m = gj.Map(use_region=True)
m.d_shade(shade="relief", color="ksat_r")
m.d_legend(raster="ksat_r", title="Ksat (mm/hr)", flags="b")
m.show()

m = gj.Map(use_region=True)
m.d_shade(shade="relief", color="ksat_h")
m.d_legend(raster="ksat_h", title="Ksat (mm/hr)", flags="b")
m.show()
```

## Hydrologic Group

```{python}
# | label: hydrologic_group_map
m = gj.Map(use_region=True)
m.d_rast(map="hsg")
m.d_shade(shade="relief", color="hsg")
m.d_legend(raster="hsg", title="Group", flags="b")
m.show()
```

## Curve Number

Install the `r.curvenumber` extension if it is not already installed. This extension is available in the GRASS Addons repository and can be installed using `g.extension`.

```{python}
# | label: install_curvenumber
# | eval: false
tools.g_extension(
    extension="r.curvenumber",
)
```

To calculate the curve number, we need both a land cover map and a hydrologic soil group map. The land cover map is from the National Land Cover Database (NLCD) 2024 dataset, which was imported as a COG raster. The `landcover_source` parameter specifies that the land cover map is from the NLCD dataset, which allows the tool to use the appropriate lookup table for curve number values.

```{python}
#| label: import_landcover
#| eval: false
tools.r_import(
    output="nlcd_2024",
    input="<path_to_nlcd_cog>",
    extent="region",
    resolution="region",
)

```

```{python}
#| label: landcover_map
m = gj.Map(use_region=True)
m.d_shade(shade="relief", color="nlcd_2024")
m.d_legend(raster="nlcd_2024", title="NLCD 2024", flags="b")
m.show()
```

Calculate the hydrolic curve number using the `r.curvenumber` extension, which requires both a land cover map and a hydrologic soil group map. The land cover map is from the National Land Cover Database (NLCD) 2024 dataset, which was imported as a COG raster. The `landcover_source` parameter specifies that the land cover map is from the NLCD dataset, which allows the tool to use the appropriate lookup table for curve number values.

```{python}
# | label: curvenumber_calc
tools.r_curvenumber(
    landcover="nlcd_2024", soil="hsg", landcover_source="nlcd", output="curvenumber"
)
```

```{python}
#| label: curvenumber_map
m = gj.Map(use_region=True)
m.d_shade(shade="relief", color="curvenumber")
m.d_legend(raster="curvenumber", title="Curve Number", flags="b")
m.show()
```

## Run model

```{python}
# | label: r_sim_water
# | eval: true
tools.r_slope_aspect(elevation="elevation", dx="dx", dy="dy")
tools.r_sim_water(elevation="elevation", depth="depth", discharge="discharge")
```


```{python}
# | label: depth_map
m = gj.Map(use_region=True)
m.d_rast(map="depth")
m.d_shade(shade="relief", color="depth")
m.show()
```

```{python}
# | label: discharge_map
m = gj.Map(use_region=True)
m.d_rast(map="discharge")
m.show()
```
